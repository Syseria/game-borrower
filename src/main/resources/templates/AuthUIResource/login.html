{#include base.html}
    {#title}Login - Game Borrower{/title}

    {#body}
        <section class="section">
            <div class="container">
                <div class="columns is-centered">
                    <div class="column is-4">
                        <div class="box">
                            <h1 class="title has-text-centered">Login</h1>
                            <form id="login-form">
                                <div class="field">
                                    <label class="label">Email</label>
                                    <div class="control">
                                        <input class="input" type="email" id="email" required>
                                    </div>
                                </div>
                                <div class="field">
                                    <label class="label">Password</label>
                                    <div class="control">
                                        <input class="input" type="password" id="password" required>
                                    </div>
                                </div>
                                <div class="field mt-5">
                                    <button class="button is-primary is-fullwidth" type="submit" id="submit-btn">Sign In</button>
                                </div>
                            </form>
                            <hr> {! Bulma divider !}

                            <div class="field">
                                <p class="has-text-centered mb-3">New to the library?</p>
                                <a href="/signup" class="button is-link is-darklight is-fullwidth">
                                    Create an Account
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <script type="module">
            import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
            import { getAuth, signInWithEmailAndPassword, connectAuthEmulator } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";

            // TODO: Replace with your actual Firebase project config from your Firebase Console
            const firebaseConfig = {
                apiKey: "fake-api-key",
                authDomain: "localhost",
                projectId: "demo-game-borrower",
                storageBucket: "demo-game-borrower.appspot.com",
                messagingSenderId: "123456789",
                appId: "1:123456789:web:abcdef"
            };

            const app = initializeApp(firebaseConfig);
            const auth = getAuth(app);

            connectAuthEmulator(auth, "http://127.0.0.1:9099");

            document.getElementById('login-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const btn = document.getElementById('submit-btn');
                btn.classList.add('is-loading');

                const email = document.getElementById('email').value;
                const password = document.getElementById('password').value;

                try {
                    // 1. Authenticate with Firebase directly from the browser
                    const userCredential = await signInWithEmailAndPassword(auth, email, password);
                    const idToken = await userCredential.user.getIdToken();

                    // 2. Exchange the Firebase ID Token for a Quarkus Session Cookie
                    const response = await fetch('/api/auth/login', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ idToken: idToken })
                    });

                    if (response.ok) {
                        window.location.href = '/catalog'; // Redirect to catalog on success
                    } else {
                        alert('Backend session creation failed.');
                    }
                } catch (error) {
                    alert('Login failed: ' + error.message);
                } finally {
                    btn.classList.remove('is-loading');
                }
            });
        </script>
    {/body}
{/include}